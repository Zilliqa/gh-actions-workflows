name: |-
  CI - Build Docker image
  
  Build Docker image and push it to ECR
  
  ### Usage 
  ```yaml
    name: Deploy
    on:
      push:
        branches: [ main ]
    jobs:
      ci:
        uses: Zilliqa/gh-actions-workflows/.github/workflows/ci-dockerized-app-build-push-docker-hub.yml@main
        with:
          commitOrTag: $\{\{ env.commitOrTag \}\}
          file: $\{\{ env.file \}\}
          context: $\{\{ env.context \}\}
          image-name: $\{\{ env.image-name \}\}
          image-tag: $\{\{ env.image-tag \}\}
          image-push: $\{\{ env.image-push \}\}
          image-target: $\{\{ env.image-target \}\}
          image-build-args: $\{\{ env.image-build-args s\}\}
          cache-key: $\{\{ env.cache-key s\}\}
        secrets:
          registry-username: $\{\{ secrets.registry-username \}\}
          registry-password: $\{\{ secrets.registry-password \}\}
          cache-username: $\{\{ secrets.cache-username \}\}
          cache-password: $\{\{ secrets.cache-password \}\}
  ```
on:
  workflow_call:
    inputs:
      commitOrTag:
        description: 'The commit hash or branch or tag to checkout'
        required: false
        default: ''
        type: string
      file:
        description: 'The path to the Dockerfile'
        required: true
        type: string
      context:
        description: 'The context to build the Dockerfile'
        required: true
        type: string
      image-name:
        description: 'The name of the image'
        required: true
        type: string
      image-tag:
        description: 'The tag of the image'
        required: false
        default: ''
        type: string
      image-build-args:
        description: 'Arguments to build the image'
        required: false
        type: string
      image-push:
        description: 'Enable/disable image push'
        required: false
        default: true
        type: boolean
      image-target:
        description: 'The target to build in the image'
        required: false
        default: ''
        type: string
      cache-key:
        description: 'The key to store/retrieve the cache'
        required: false
        default: ''
        type: string
      runner:
        description: 'The runner label for the build'
        required: false
        default: 'ubuntu-22.04'
        type: string
    secrets:
      registry-username:
        description: 'The username to access the registry'
        required: true
      registry-password:
        description: 'The password to access the registry'
        required: true
      cache-username:
        description: 'The username to access the cache'
        required: true
      cache-password:
        description: 'The password to access the cache'
        required: true

jobs:
  build:
    name: build
    runs-on: ${{ inputs.runner }}
    steps:
      - name: 'Checkout scm ${{ inputs.commitOrTag }}'
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: ${{ inputs.commitOrTag }}
      - name: Build and push Docker images
        uses: Zilliqa/gh-actions-workflows/actions/docker-build-push@main
        with:
          file: ${{ inputs.file }}
          context: ${{ inputs.context }}
          build-args: ${{ inputs.image-build-args }}
          image-name: ${{ inputs.image-name }}
          image-tag: ${{ inputs.image-tag }}
          push: ${{ inputs.image-push }}
          target: ${{ inputs.image-target }}
          cache-key: ${{ inputs.cache-key }}
          cache-username: ${{ secrets.cache-username }}
          cache-password: ${{ secrets.cache-password }}
          registry-username: ${{ secrets.registry-username }}
          registry-password: ${{ secrets.registry-password }}
